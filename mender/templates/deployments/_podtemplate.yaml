{{- define "mender.deploymentsPodTemplate" -}}
metadata:
  {{- with .dot.Values.deployments.podAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  labels:
    {{- include "mender.labels" . | nindent 4 }}
spec:
  containers:
  - name: {{ default "deployments" .containerName | quote }}
    {{ include "mender.container" . | nindent 4 }}
    env:
    - name: DEPLOYMENTS_MONGO_URL
      {{- include "mender.mongoUrl" . | nindent 6 }}
    - name: DEPLOYMENTS_REDIS_CONNECTION_STRING
      {{- include "mender.redisUrl" . | nindent 6 }}
    - name: DEPLOYMENTS_STORAGE_DEFAULT
      value: {{ if and .dot.Values.global .dot.Values.global.storage }}
             {{- quote .dot.Values.global.storage }}
             {{- else }}
             {{- quote .dot.Values.storage.type }}
             {{- end }}
    - name: DEPLOYMENTS_MIDDLEWARE
      value: {{ .dot.Values.deployments.env.DEPLOYMENTS_MIDDLEWARE | quote }}
    - name: DEPLOYMENTS_AWS_TAG_ARTIFACT
      value: {{ .dot.Values.deployments.env.DEPLOYMENTS_AWS_TAG_ARTIFACT | quote }}
    {{- if and .dot.Values.deployments.env.DEPLOYMENTS_PRESIGN_SECRET ( not .dot.Values.deployments.presignSecretExistingSecret ) }}
    - name: DEPLOYMENTS_PRESIGN_SECRET
      value: {{ .dot.Values.deployments.env.DEPLOYMENTS_PRESIGN_SECRET | quote }}
    {{- end }}
    {{- if and .dot.Values.auditlogs.enabled .dot.Values.enterprise }}
    - name: DEPLOYMENTS_ENABLE_AUDIT
      value: "true"
    {{- end }}
    {{- if .dot.Values.deployments.directUpload.enabled }}
    - name: DEPLOYMENTS_STORAGE_ENABLE_DIRECT_UPLOAD
      value: "true"
    {{- if .dot.Values.deployments.directUpload.skipVerify }}
    - name: DEPLOYMENTS_STORAGE_DIRECT_UPLOAD_SKIP_VERIFY
      value: "true"
    {{- end }}
    {{- end }}
    {{- range $k, $v := .override.env }}
    - name: {{ quote $k }}
      value: {{ quote $v }}
    {{- end }}
    {{- with coalesce .override.customEnvs .dot.Values.default.customEnvs }}
    {{- toYaml . | indent 4 }}
    {{- end }}
    envFrom:
    {{- if (not .migration) }}
    - prefix: DEPLOYMENTS_
      secretRef:
        name: {{ if and .dot.Values.global
                        .dot.Values.global.s3
                        .dot.Values.global.s3.existingSecret }}
              {{- quote .dot.Values.global.s3.existingSecret }}
              {{- else }}
              {{- default "artifacts-storage" .dot.Values.storage.existingSecret }}
              {{- end }}
    {{- end }}
    {{- if and ( not .dot.Values.deployments.env.DEPLOYMENTS_PRESIGN_SECRET ) .dot.Values.deployments.presignSecretExistingSecret }}
    - prefix: DEPLOYMENTS_
      secretRef:
        name: {{ .dot.Values.deployments.presignSecretExistingSecret | quote }}
    {{- end }}
  {{- include "mender.podSpec" . | nindent 2}}
{{- end }}
